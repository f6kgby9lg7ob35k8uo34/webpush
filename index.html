<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Push Notification Debugging</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 600px;
            margin: 2rem auto;
            padding: 0 1rem;
            background-color: #f5f5f5;
        }
        .notification-status {
            margin: 1rem 0;
            padding: 1rem;
            border-radius: 4px;
        }
        .success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        button {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 4px;
            cursor: pointer;
            font-size: 1rem;
            transition: background-color 0.2s;
        }
        button:hover {
            background-color: #0056b3;
        }
        button:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }
        .container {
            background-color: white;
            padding: 2rem;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        h1 {
            color: #333;
            margin-bottom: 1.5rem;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Push Notification Debugging</h1>
        <button id="subscribe" disabled>Loading...</button>
        <div id="status" class="notification-status"></div>

        <script>
            const VAPID_PUBLIC_KEY = 'BHD2aSub6GMA8iak6e4ltV9sNUf3QbmwrintNby94t3zfOVY_OEDPsBbZXdMXwkCBVYknHDDTsLWU9vq0C4Gp_s';
            const BACKEND_URL = 'https://blue-mode-1e8c.rohand-1.workers.dev';
            let swRegistration = null;

            // Utility: Update the status message on the page
            function updateStatus(message, type) {
                const status = document.getElementById('status');
                status.textContent = message;
                status.className = `notification-status ${type}`;
            }

            // Utility: Convert VAPID key to Uint8Array
            function urlB64ToUint8Array(base64String) {
                const padding = '='.repeat((4 - base64String.length % 4) % 4);
                const base64 = (base64String + padding).replace(/-/g, '+').replace(/_/g, '/');
                const rawData = window.atob(base64);
                const outputArray = new Uint8Array(rawData.length);
                for (let i = 0; i < rawData.length; ++i) {
                    outputArray[i] = rawData.charCodeAt(i);
                }
                return outputArray;
            }

            // Register Service Worker and Initialize UI
            if ('serviceWorker' in navigator && 'PushManager' in window) {
                window.addEventListener('load', () => {
                    navigator.serviceWorker.register('webpush/service-worker.js')
                        .then(registration => {
                            console.log('Service Worker registered with scope:', registration.scope);
                            swRegistration = registration;
                            initializeUI();
                            checkSubscription();
                        })
                        .catch(err => {
                            console.error('Service Worker registration failed:', {
                                message: err.message,
                                name: err.name,
                                stack: err.stack
                            });
                            updateStatus('Service Worker registration failed: ' + err.message, 'error');
                        });
                });
            } else {
                console.warn('Service Workers or Push Notifications are not supported in this browser.');
                updateStatus('Push notifications are not supported in your browser.', 'error');
            }

            // Check Subscription Status
            async function checkSubscription() {
                try {
                    const subscription = await swRegistration.pushManager.getSubscription();
                    const subscribeButton = document.getElementById('subscribe');
                    if (subscription) {
                        console.log('User is already subscribed:', subscription);
                        updateStatus('You are already subscribed to notifications.', 'success');
                        subscribeButton.textContent = 'Unsubscribe';
                    } else {
                        updateStatus('You are not subscribed to notifications.', 'error');
                        subscribeButton.textContent = 'Subscribe';
                    }
                    subscribeButton.disabled = false;
                } catch (err) {
                    console.error('Error checking subscription:', err);
                    updateStatus('Error checking subscription: ' + err.message, 'error');
                }
            }

            // Initialize Subscribe/Unsubscribe Button
            function initializeUI() {
                const subscribeButton = document.getElementById('subscribe');
                subscribeButton.addEventListener('click', async () => {
                    subscribeButton.disabled = true;
                    try {
                        const subscription = await swRegistration.pushManager.getSubscription();
                        if (subscription) {
                            await unsubscribeUser();
                        } else {
                            await subscribeUserToPush();
                        }
                    } catch (err) {
                        console.error('Error during subscription/unsubscription:', err);
                        updateStatus('Error during subscription/unsubscription: ' + err.message, 'error');
                    }
                    checkSubscription();
                });
            }

            // Subscribe User to Push Notifications
            async function subscribeUserToPush() {
                try {
                    const applicationServerKey = urlB64ToUint8Array(VAPID_PUBLIC_KEY);
                    const subscription = await swRegistration.pushManager.subscribe({
                        userVisibleOnly: true,
                        applicationServerKey: applicationServerKey
                    });
                    console.log('Push subscription successful:', subscription);

                    updateStatus('Successfully subscribed to push notifications!', 'success');
                    await fetch(`${BACKEND_URL}/subscribe`, {
                        method: 'POST',
                        body: JSON.stringify(subscription),
                        headers: { 'Content-Type': 'application/json' }
                    });
                } catch (err) {
                    console.error('Failed to subscribe:', err.message, err);
                    updateStatus('Failed to subscribe: ' + err.message, 'error');
                }
            }

            // Unsubscribe User
            async function unsubscribeUser() {
                try {
                    const subscription = await swRegistration.pushManager.getSubscription();
                    if (subscription) {
                        await subscription.unsubscribe();
                        console.log('User unsubscribed:', subscription);

                        updateStatus('Successfully unsubscribed from notifications.', 'success');
                        await fetch(`${BACKEND_URL}/unsubscribe`, {
                            method: 'POST',
                            body: JSON.stringify(subscription),
                            headers: { 'Content-Type': 'application/json' }
                        });
                    }
                } catch (err) {
                    console.error('Failed to unsubscribe:', err.message, err);
                    updateStatus('Failed to unsubscribe: ' + err.message, 'error');
                }
            }
        </script>
    </div>
</body>
</html>
